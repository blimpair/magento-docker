#!/bin/sh
set -ex

## Magento install config
$WORKDIR/bin/magento setup:install \
  --base-url=${VIRTUAL_PROTO}://${VIRTUAL_HOST}/magento2ee \
  --db-host=${VIRTUAL_HOST} \
  --db-name=${MYSQL_DATABASE} \
  --db-user=${MYSQL_USER} \
  --db-password=${MYSQL_PASSWORD} \
  --backend-frontname=${BACKEND_FRONTNAME} \
  --admin-firstname=${ADMIN_FIRSTNAME} \
  --admin-lastname=${ADMIN_LASTNAME} \
  --admin-email=${ADMIN_EMAIL} \
  --admin-user=${ADMIN_USERNAME} \
  --admin-password=${ADMIN_PASSWORD} \
  --language=${LANGUAGE} \
  --currency=${CURRENCY} \
  --timezone=${TIMEZONE} \
  --use-rewrites=${REWRITES_ENABLED}

## Magento redis enable as session manager
$WORKDIR/bin/magento setup:config:set
  --session-save=redis \
  --session-save-redis-host=${REDIS_HOST} \
  --session-save-redis-log-level=3 \
  --session-save-redis-db=2

## Magento redis as default caching
$WORKDIR/bin/magento setup:config:set \
  --cache-backend=redis \
  --cache-backend-redis-server=${REDIS_HOST} \
  --cache-backend-redis-db=0

## Magento redis full page cache
$WORKDIR/bin/magento setup:config:set \
  --page-cache=redis \
  --page-cache-redis-server=${REDIS_HOST} \
  --page-cache-redis-db=1

## Magento elasticsearch enable

## Enabling Varnish
$WORKDIR/bin/magento config:set \
  --scope=default \
  --scope-code=0 \
  system/full_page_cache/caching_application 2

## Setting Magento mode
$WORKDIR/bin/magento \
  deploy:mode:set \
  ${MAGENTO_MODE}

exit 0
